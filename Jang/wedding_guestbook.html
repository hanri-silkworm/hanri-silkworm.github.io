<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>장순이 × 장풍이 결혼식 — 방명록</title>
  <meta name="description" content="장순이와 장풍이의 웨딩 방명록 페이지입니다." />
  <style>
    :root {
      --bg: #fff7fb; --fg: #1f2937; --muted: #6b7280;
      --pink: #f472b6; --pink-100: #fce7f3; --pink-200: #fbcfe8;
      --purple: #8b5cf6; --purple-100: #ede9fe; --card: #ffffff;
      --ring: rgba(139, 92, 246, .28);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;
      -webkit-font-smoothing:antialiased
    }

    /* ===== HERO ===== */
    header.hero{position:relative}
    .hero-imgwrap{position:relative;width:100%;height:clamp(220px,38vw,420px);overflow:hidden}
    .hero-imgwrap img{width:100%;height:100%;object-fit:cover;display:block;filter:saturate(1.05) contrast(1.03)}
    .hero-overlay{position:absolute;inset:0;background:
      radial-gradient(1000px 400px at 10% 10%, var(--pink-100), transparent),
      radial-gradient(800px 300px at 90% 0%, var(--purple-100), transparent),
      linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,0) 45%, rgba(255,247,251,0) 70%, var(--bg));
      pointer-events:none}
    .hero-inner{max-width:1100px;margin:0 auto;padding:18px 16px 28px;position:relative;margin-top:-60px}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--purple-100);color:#5b21b6;font-weight:600;font-size:12px;box-shadow:0 1px 0 rgba(0,0,0,.04) inset}
    h1{margin:12px 0 8px;font-size:clamp(28px,4vw,44px);letter-spacing:-.5px;color:#111827;text-shadow:0 1px 0 rgba(255,255,255,.6)}
    .sub{color:var(--muted);margin-top:6px}
    .raffle{margin-top:10px;background:var(--pink-100);color:#7c2d12;border:1px solid var(--pink-200);padding:10px 12px;border-radius:12px;font-size:14px}
    .raffle strong{color:#9a3412}

    /* ===== LAYOUT ===== */
    main{max-width:1100px;margin:0 auto 64px;padding:0 16px}
    .grid{display:grid;gap:24px;grid-template-columns:1fr}
    @media (min-width:980px){ .grid{ grid-template-columns:1fr 1fr } }

    section.card{background:var(--card);border-radius:20px;padding:20px;box-shadow:0 10px 24px rgba(0,0,0,.06);border:1px solid #edecec}
    section.card h2{margin:6px 0 12px;font-size:20px}
    .hint{color:var(--muted);font-size:13px;margin:8px 0 16px}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:12px}

    /* ===== FORM ===== */
    form .row{margin-bottom:12px}
    label{display:block;font-weight:600;font-size:14px;margin-bottom:6px}
    input[type="text"],input[type="tel"]{
      width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;font-size:15px;
      outline:none;box-shadow:0 1px 0 rgba(0,0,0,.02) inset
    }
    input:focus{border-color:var(--purple);box-shadow:0 0 0 4px var(--ring)}
    .checkbox{display:flex;align-items:center;gap:10px}
    .checkbox input{width:18px;height:18px;accent-color:var(--purple)}
    .hp{position:absolute;left:-5000px;top:-5000px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;border-radius:12px;border:0;color:#fff;font-weight:700;cursor:pointer;background:linear-gradient(90deg,var(--pink),var(--purple));box-shadow:0 6px 16px rgba(139,92,246,.25)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-secondary{border:1px solid var(--purple-100);background:#f5f3ff;color:#4c1d95;font-weight:700;padding:10px 14px;border-radius:12px}
    .note{font-size:13px;color:var(--muted);margin-top:6px}
    #submitBtn{display:block;margin:12px auto 0} /* 방명록 남기기 버튼만 중앙정렬 */

    /* ===== LIST (세로 5개/페이지) ===== */
    #list{display:flex;flex-direction:column;gap:12px}
    .msg{border:1px solid #e5e7eb;border-radius:14px;padding:12px 14px;background:#fff;cursor:pointer}
    .msg:active{transform:scale(0.995)}
    .msg-top{display:flex;align-items:baseline;gap:8px}
    .nick{font-weight:700}.time{font-size:12px;color:var(--muted)}
    .text{
      margin:6px 0 0;word-break:break-word;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }

    .pager{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;margin-top:10px}
    .pager .pages{display:flex;gap:6px;align-items:center}
    .page-btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
    .page-btn.active{border-color:#c7d2fe;background:#eef2ff;color:#3730a3}
    .status{font-size:13px}.ok{color:#16a34a}.warn{color:#a16207}.err{color:#dc2626}

    /* ===== MODAL ===== */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal.show{display:flex}
    .modal-card{background:#fff;border-radius:16px;max-width:640px;width:min(640px,95vw);max-height:80vh;overflow:auto;box-shadow:0 20px 40px rgba(0,0,0,.2);padding:20px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
    .modal-title{font-weight:700}
    .modal-close{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}

    footer{text-align:center;color:var(--muted);padding:32px 16px 56px}
  </style>
</head>
<body>
  <header class="hero">
    <div class="hero-imgwrap">
      <img src="https://www.hanri.net/Jang/Jangpoon_jangsoon_title.png" alt="장순이 × 장풍이 웨딩 이미지" />
      <div class="hero-overlay"></div>
    </div>
    <div class="hero-inner">
      <span class="badge">Wedding Guestbook</span>
      <h1>장순이 × 장풍이</h1>
      <p class="sub">소중한 마음을 방명록으로 남겨 주세요. 두 주인공이 평생 간직합니다.</p>
      <p class="raffle"><strong>이벤트 안내:</strong> 방명록을 남겨 주신 분 중 추첨으로 <strong id="prizeName">장순이·장풍이 청첩장 아크릴 키링과 스타벅스 쿠폰</strong>을 드립니다. <span id="raffleInfo">마감 · 당첨자 개별 연락</span></p>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- 작성 영역 -->
      <section class="card" aria-labelledby="write-title">
        <h2 id="write-title">방명록 남기기</h2>
        <p class="hint">필수 항목은 <strong>닉네임</strong>과 <strong>한줄 글</strong>입니다. <strong>이벤트 참여자만</strong> 휴대폰 번호를 입력합니다. <em>이벤트 미참여자는 체크할 필요가 없습니다.</em></p>
        <form id="guestForm" novalidate>
          <div class="row">
            <label for="nickname">닉네임 *</label>
            <input id="nickname" name="nickname" type="text" autocomplete="nickname" required minlength="1" maxlength="30" placeholder="예: 장풍이사랑" />
          </div>

          <div class="row checkbox">
            <input id="eventOptin" name="eventOptin" type="checkbox" />
            <label for="eventOptin">이벤트에 참여합니다(개인정보 수집·이용 동의)</label>
          </div>

          <div class="row" id="phoneRow">
            <label for="phone">휴대폰 번호 <span class="muted">(이벤트 참여 시 필수)</span></label>
            <input id="phone" name="phone" type="tel" inputmode="tel" autocomplete="tel" placeholder="예: 010-1234-5678" maxlength="13" pattern="^[0-9-]+$" />
            <div class="note">숫자만 입력하면 자동으로 하이픈이 들어갑니다. 경품 발송 후 파기합니다.</div>
          </div>

          <div class="row">
            <label for="message">한줄 글 *</label>
            <input id="message" name="message" type="text" required maxlength="120" placeholder="축하 메시지를 120자 이내로 남겨 주세요" />
          </div>

          <!-- 스팸 방지용 허니팟 -->
          <div class="hp">
            <label for="website">Leave this empty</label>
            <input id="website" name="website" type="text" tabindex="-1" autocomplete="off" />
          </div>

          <button class="btn" id="submitBtn" type="submit">방명록 남기기</button>
          <div id="formStatus" class="status" aria-live="polite" style="margin-top:8px"></div>
        </form>
      </section>

      <!-- 읽기 영역 -->
      <section class="card" aria-labelledby="read-title">
        <div class="row-between">
          <h2 id="read-title">모두의 메시지</h2>
          <button id="refreshBtn" class="btn-secondary" type="button" title="목록 새로고침">새로고침</button>
        </div>

        <div id="list" class="list" aria-live="polite"></div>

        <div class="pager">
          <button id="prevPage" class="btn-secondary" type="button">이전</button>
          <span id="pageNumbers" class="pages"></span>
          <button id="nextPage" class="btn-secondary" type="button">다음</button>
          <span id="listStatus" class="status"></span>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:24px" aria-labelledby="tips-title">
      <h2 id="tips-title">개인정보 및 이벤트 안내</h2>
      <ul>
        <li>이벤트 참여자는 휴대폰 번호 제공이 필요합니다(경품 발송·당첨 안내 목적).</li>
        <li>수집 항목: 닉네임, (이벤트 참여 시만) 휴대폰 번호, 한줄 글.</li>
        <li>보유 기간: 이벤트 종료 및 경품 발송 완료 후 즉시 파기.</li>
      </ul>
    </section>
  </main>

  <footer>
    <p>축하해 주셔서 고맙습니다 💗💜</p>
  </footer>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div>
          <div id="modalTitle" class="modal-title">메시지 상세</div>
          <div id="modalMeta" class="muted" style="font-size:12px;color:#6b7280"></div>
        </div>
        <button id="modalClose" class="modal-close" type="button">닫기</button>
      </div>
      <div id="modalBody" style="white-space:pre-wrap;line-height:1.6"></div>
    </div>
  </div>

  <script>
    // ===== 설정 =====
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz-xBykDWzkt6MT-30sGsrAvqaed_G_hRmEhewKV4j7gUG5D-m3MG1UEQarxiCzYMtp/exec";

    const RAFFLE = { PRIZE_NAME: "장순이·장풍이 청첩장 아크릴 키링과 스타벅스 쿠폰", PRIZES_COUNT: 5, DEADLINE: "2025-11-30 23:59", CONTACT: "당첨자 개별 연락" };
    const VIEW_PAGE_SIZE = 5;          // 5개/페이지 (세로 리스트)
    const FETCH_LIMIT = 300;           // 최대 300개 캐싱
    let rowsCache = [];
    let currentPage = 1;

    const $ = (sel, el=document) => el.querySelector(sel);
    const setStatus = (el, msg, cls) => { el.textContent = msg || ''; el.className = `status ${cls||''}`; };
    const digitsOnly = s => String(s||'').replace(/\D/g,'');

    function formatKoreanPhone(d){ if(d.length<=3) return d; if(d.length<=7) return d.slice(0,3)+'-'+d.slice(3); if(d.length===10) return d.slice(0,3)+'-'+d.slice(3,6)+'-'+d.slice(6); return d.slice(0,3)+'-'+d.slice(3,7)+'-'+d.slice(7,11); }
    function handlePhoneInput(){ const el=$("#phone"); const d=digitsOnly(el.value).slice(0,11); el.value=formatKoreanPhone(d); }
    function togglePhoneRequired(){ const checked=$("#eventOptin").checked; const phone=$("#phone"); if(checked){phone.setAttribute('required','required')}else{phone.removeAttribute('required')} }
    function setRaffleText(){ const txt=`추첨 ${RAFFLE.PRIZES_COUNT}명 / 마감: ${RAFFLE.DEADLINE} / ${RAFFLE.CONTACT}`; const PN=$("#prizeName"); if(PN) PN.textContent=RAFFLE.PRIZE_NAME; const RI=$("#raffleInfo"); if(RI) RI.textContent=txt; }

    async function fetchMessages(limit){
      const url = `${SCRIPT_URL}?mode=list&limit=${limit}&_=${Date.now()}`;
      try{
        const res = await fetch(url, {method:'GET'});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        return (data && data.rows) || [];
      }catch(_){
        // JSONP 폴백
        return new Promise((resolve,reject)=>{
          const cbName = `__guestbookCB_${Date.now()}`;
          window[cbName] = (data)=>{ try{ resolve((data&&data.rows)||[]); } finally { delete window[cbName]; s.remove(); } };
          const s = document.createElement('script');
          s.src = `${SCRIPT_URL}?mode=list&limit=${limit}&callback=${cbName}&_=${Date.now()}`;
          s.onerror = ()=>{ s.remove(); delete window[cbName]; reject(new Error('JSONP failed')); };
          document.body.appendChild(s);
        });
      }
    }

    function renderPage(page){
      const list = $("#list");
      const totalPages = Math.max(1, Math.ceil(rowsCache.length / VIEW_PAGE_SIZE));
      currentPage = Math.min(Math.max(1, page), totalPages);

      const start = (currentPage - 1) * VIEW_PAGE_SIZE;
      const end = start + VIEW_PAGE_SIZE;
      const slice = rowsCache.slice(start, end);

      list.replaceChildren(...slice.map((r, i)=>{
        const globalIndex = start + i;
        const art=document.createElement('article'); art.className='msg'; art.tabIndex=0;
        art.dataset.index = String(globalIndex);
        art.addEventListener('click', ()=>openModal(globalIndex));
        art.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter' || ev.key===' ') { ev.preventDefault(); openModal(globalIndex); } });
        const top=document.createElement('div'); top.className='msg-top';
        const nick=document.createElement('span'); nick.className='nick'; nick.textContent=r.nickname||'익명';
        const time=document.createElement('span'); time.className='time'; time.textContent=r.timestamp||'';
        const p=document.createElement('p'); p.className='text'; p.textContent=r.message||'';
        top.append(nick,time); art.append(top,p); return art;
      }));

      buildPageNumbers(totalPages);
      $("#prevPage").disabled = currentPage === 1;
      $("#nextPage").disabled = currentPage === totalPages;
      setStatus($("#listStatus"), `${currentPage}/${totalPages}페이지 · 총 ${rowsCache.length}개`, "");
    }

    function buildPageNumbers(totalPages){
      const wrap = $("#pageNumbers");
      wrap.replaceChildren();
      for(let p=1; p<=totalPages; p++){
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'page-btn' + (p===currentPage ? ' active' : '');
        b.textContent = String(p);
        b.addEventListener('click', ()=>renderPage(p));
        wrap.appendChild(b);
      }
    }

    async function reloadAll(){
      const listStatus = $("#listStatus");
      try{
        setStatus(listStatus,"불러오는 중…","warn");
        rowsCache = await fetchMessages(FETCH_LIMIT);
        if(!Array.isArray(rowsCache)) rowsCache = [];
        renderPage(1);
      }catch(err){
        setStatus(listStatus, `목록을 불러오지 못했습니다: ${err.message}`, "err");
      }
    }

    // ===== MODAL =====
    const modal = $("#modal");
    const modalTitle = $("#modalTitle");
    const modalMeta = $("#modalMeta");
    const modalBody = $("#modalBody");
    const modalClose = $("#modalClose");

    function openModal(idx){
      const r = rowsCache[idx]; if(!r) return;
      modalTitle.textContent = "메시지 상세";
      modalMeta.textContent = `${r.nickname || '익명'} · ${r.timestamp || ''}`;
      modalBody.textContent = r.message || '';
      modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      modal.classList.remove('show'); modal.setAttribute('aria-hidden','true');
    }
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });
    modalClose.addEventListener('click', closeModal);
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('show')) closeModal(); });

    // ===== 제출 =====
    $("#guestForm").addEventListener('submit', async (e)=>{
      e.preventDefault();
      const status = $("#formStatus"); const btn = $("#submitBtn");
      if($("#website").value){ setStatus(status,"스팸이 의심되어 전송하지 않습니다.","err"); return; }

      const nickname = $("#nickname").value.trim();
      const eventOptin = $("#eventOptin").checked;
      const phoneDigits = digitsOnly($("#phone").value.trim());
      const message = $("#message").value.trim();

      if(!nickname || nickname.length>30){ setStatus(status,"닉네임을 1–30자로 입력해 주세요.","err"); return; }
      if(!eventOptin && phoneDigits.length>0){ setStatus(status,"이벤트 참여자만 휴대폰 번호를 입력합니다. 참여하려면 이벤트 체크를 해 주세요.","err"); return; }
      if(eventOptin && (phoneDigits.length<10 || phoneDigits.length>11)){ setStatus(status,"휴대폰 번호는 10~11자리여야 합니다.","err"); return; }
      if(!message){ setStatus(status,"한줄 글을 입력해 주세요.","err"); return; }

      try{
        btn.disabled = true; setStatus(status,"전송 중…","warn");

        const body = new URLSearchParams({
          nickname,
          message,
          eventOptin: eventOptin ? 'true' : 'false',
          phone: eventOptin ? formatKoreanPhone(phoneDigits) : ''
        });
        const res = await fetch(SCRIPT_URL, { method:'POST', body });

        let serverOK = false;
        try{
          const txt = await res.text();
          serverOK = /"ok"\s*:\s*true/.test(txt);
        }catch(_){ serverOK = false; }

        const oldCount = rowsCache.length;
        await reloadAll();
        const newCount = rowsCache.length;

        if(res.ok && (serverOK || newCount > oldCount)){
          setStatus(status,"등록되었습니다. 축하와 응원에 감사드립니다!","ok");
          $("#message").value=''; if(!eventOptin){ $("#phone").value=''; }
          renderPage(1);
          document.getElementById("read-title").scrollIntoView({ behavior:'smooth', block:'start' });
        }else{
          setStatus(status,"등록에 실패했습니다. 잠시 후 다시 시도해 주세요.","err");
        }
      }catch(err){
        setStatus(status,`전송 실패: ${err.message}`,"err");
      }finally{
        btn.disabled = false;
      }
    });

    // ===== 버튼 & 초기화 =====
    $("#refreshBtn").addEventListener('click', reloadAll);
    $("#prevPage").addEventListener('click', ()=>renderPage(currentPage-1));
    $("#nextPage").addEventListener('click', ()=>renderPage(currentPage+1));

    (function init(){
      togglePhoneRequired(); setRaffleText(); reloadAll();
    })();
  </script>
</body>
</html>
