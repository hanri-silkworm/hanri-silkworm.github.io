<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>참가 제출지 – 제 3회 누에 고치 성별 맞추기 대회</title>
  <style>
    :root{
      --bg:#ffffff; --paper:#ffffff; --ink:#111827; --sub:#6b7280;
      --pri:#4b5563; --muted:#e5e7eb; --ring:rgba(107,114,128,.25);
      --shadow:0 10px 30px rgba(17,24,39,.08);
      --green:#059669; --blue:#1e3a8a; --blue-bd:#bfdbfe; --blue-bg:#eff6ff;
      --rose:#9d174d; --rose-bd:#fbcfe8; --rose-bg:#fdf2f8;
      --danger:#ef4444; --danger-bd:#fecaca; --danger-bg:#fef2f2;

      /* 타입 컬러 */
      --gold:#f59e0b; --gold-bg:#fff7ed;
      --mimic:#7c3aed; --mimic-bg:#f5f3ff;
      --trap:#b91c1c; --trap-bg:#fef2f2;
      --normal:#374151; --normal-bg:#f3f4f6;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header.nav{position:sticky;top:0;backdrop-filter:saturate(180%) blur(8px);background:rgba(247,246,243,.75);border-bottom:1px solid var(--muted);z-index:50}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:14px 24px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--ink)}
    .brand strong{font-weight:800}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 14px;border-radius:999px;border:1px solid var(--muted);
      background:var(--paper);color:var(--ink);text-decoration:none;font-weight:600;
      text-align:center;
    }
    .btn.primary{background:var(--pri);color:#fff;border:0}
    .btn.success{background:var(--green);color:#fff;border:0}
    .btn:hover{box-shadow:0 6px 18px rgba(15,23,42,.08)}
    .btn.lg{font-size:16px; padding:10px 18px; min-height:42px; min-width:140px}
    @media (min-width:768px){ .btn.lg{font-size:17px; padding:12px 22px; min-width:180px} }

    .hero{margin:20px auto 14px;border-radius:24px;background:
      radial-gradient(1200px 600px at 10% -10%, #f3f4f6, transparent 60%),
      radial-gradient(1200px 600px at 110% 10%, #eef2f7, transparent 60%),
      var(--paper);box-shadow:var(--shadow)}
    .hero-grid{display:grid;grid-template-columns:1fr;gap:12px;padding:24px}
    .hero h1{margin:0;font-size:clamp(22px,4vw,32px);letter-spacing:-.3px;line-height:1.15;text-align:center}
    .hero .sub{margin:6px 0 0;color:var(--sub);font-weight:600;text-align:center}

    .card{background:var(--paper);border:1px solid var(--muted);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
    .card .inner{padding:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}

    label{font-weight:700;display:block;margin-bottom:6px}
    .subnote{color:var(--sub);font-size:12px;margin-top:4px}
    input[type="text"], input[type="tel"]{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--muted); outline:none; background:#fff;
    }
    input[type="text"]:focus, input[type="tel"]:focus{box-shadow:0 0 0 3px var(--ring)}
    input.invalid{border-color:var(--danger); box-shadow:0 0 0 2px rgba(239,68,68,.2)}
    .checkbox-invalid{outline:2px solid rgba(239,68,68,.6); outline-offset:3px; border-radius:6px; padding:2px}

    fieldset{border:1px solid var(--muted);border-radius:14px;padding:14px;transition:border-color .12s ease, box-shadow .12s ease, background .12s ease}
    fieldset.invalid{border-color:var(--danger-bd)}
    legend{font-weight:800;color:var(--blue);padding:0 6px}
    .qgrid{display:grid;grid-template-columns:140px 1fr 1fr;gap:14px;align-items:center}
    @media (max-width:900px){.qgrid{grid-template-columns:1fr}}
    .photo{width:140px;height:140px;border-radius:12px;background:#f3f4f6;border:1px solid var(--muted);display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
    .photo img{width:100%;height:100%;object-fit:cover;object-position:center;display:block;-webkit-user-drag:none;user-select:none}
    .name{font-weight:800}

    /* 타입 배지 & 칩 */
    .flag{
      position:absolute; left:8px; top:8px; padding:4px 8px; border-radius:999px;
      font-size:12px; font-weight:800; border:1px solid transparent; display:inline-flex; align-items:center; gap:6px;
      background:#fff;
    }
    .flag i{font-style:normal}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid transparent;font-size:12px; font-weight:800; width:fit-content}

    /* 타입별 컬러링 */
    fieldset.type-normal{border-color:#e5e7eb; background:linear-gradient(180deg,var(--normal-bg),#fff 45%);}  
    fieldset.type-gold{border-color:var(--gold); background:linear-gradient(180deg,var(--gold-bg),#fff 45%); box-shadow:0 6px 20px rgba(245,158,11,.1)}
    fieldset.type-mimic{border-color:var(--mimic); background:linear-gradient(180deg,var(--mimic-bg),#fff 45%); box-shadow:0 6px 20px rgba(124,58,237,.08)}
    fieldset.type-trap{border-color:var(--trap); background:linear-gradient(180deg,var(--trap-bg),#fff 45%); box-shadow:0 6px 20px rgba(185,28,28,.08)}

    .flag.normal{color:var(--normal); border-color:#d1d5db; background:#fff}
    .flag.gold{color:var(--gold); border-color:#fcd34d; background:#fffdf4}
    .flag.mimic{color:var(--mimic); border-color:#ddd6fe; background:#faf7ff}
    .flag.trap{color:var(--trap); border-color:#fecaca; background:#fff5f5}

    .pill.normal{color:var(--normal); border-color:#d1d5db; background:#fff}
    .pill.gold{color:var(--gold); border-color:#fcd34d; background:#fffdf4}
    .pill.mimic{color:var(--mimic); border-color:#ddd6fe; background:#faf7ff}
    .pill.trap{color:var(--trap); border-color:#fecaca; background:#fff5f5}
    /* 비활성 칩 */
    .pill.disabled{color:#6b7280; border-color:#e5e7eb; background:#f9fafb}

    /* 상태 안내문구 */
    #status{min-height:24px; text-align:center; margin-top:6px}
    .notice{background:none !important; border:0 !important; border-radius:0 !important; padding:0 !important; display:inline !important; font-weight:700;}
    .notice-ok{color:#065f46}
    .notice-err{color:#b91c1c}

    .actions{display:flex;gap:12px;justify-content:center;padding:16px}
    .agree{display:flex;gap:8px;align-items:flex-start;margin-top:10px}
    .hp{position:absolute;left:-9999px;top:-9999px}

    .form-section-title{ text-align:center; }

    /* 타입 전설(설명) */
    .legend-box{margin:16px 0 0; padding:12px; border:1px dashed #d1d5db; border-radius:12px; background:#fafafa}
    .legend-row{display:flex; gap:8px; flex-wrap:wrap}

    /* 규칙 목록 */
    .rules{ margin:10px 0 0; padding-left:18px; }
    .rules li{ margin:4px 0; }

    /* 아코디언 */
    .qa{ margin-top:12px }
    .qa details{ margin:8px 0; border:0 }
    .qa summary{
      list-style:none; cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 12px; border:1px solid #d1d5db; border-radius:10px;
      background:#f3f4f6; color:#374151; font-weight:800;
      transition:background .15s ease, border-color .15s ease, box-shadow .15s ease, color .15s ease;
    }
    .qa summary::-webkit-details-marker{display:none}
    .qa summary::after{ content:"▸"; font-size:14px; line-height:1; transform-origin:center; transition:transform .15s ease; color:#6b7280 }
    .qa details[open] summary{ background:#e5e7eb; border-color:#cbd5e1; border-bottom-left-radius:0; border-bottom-right-radius:0; }
    .qa details[open] summary::after{ transform:rotate(90deg) }
    .qa .ans{
      padding:12px; border:1px solid #cbd5e1; border-top:0; border-bottom-left-radius:10px; border-bottom-right-radius:10px;
      background:#fff; color:#111827;
    }

    /* 공지(오픈채팅) 블록 */
    .announce{ margin:12px 0 0; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:linear-gradient(180deg,#fffbe7,#fff); }
    .announce-row{ display:flex; flex-direction:column; align-items:center; gap:12px; text-align:center }
    .announce strong{ display:block; font-size:16px; margin-bottom:4px }
    .announce p{ margin:0; color:var(--sub) }
    .btn.kakao{ background:#FEE500; color:#111827; border:0; font-weight:800; white-space:nowrap }

    /* 모바일 최적화 */
    @media (max-width:720px){ .announce-row{ flex-direction:column; align-items:center } .btn.kakao{ width:auto } .photo{ width:100%; height:clamp(180px,58vw,260px); } }
    @media (max-width:480px){
      .nav-inner{ gap:8px; padding:10px 12px; }
      .nav-inner > .brand{ flex:1 1 auto; min-width:0; max-width:55%; }
      .brand{ font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      header.nav .nav-inner > div{ display:flex; gap:8px; flex-wrap:nowrap; }
      header.nav .btn{ font-size:14px; padding:8px 10px; white-space:nowrap; }
    }

    /* 참여 확인(퀵 체크) */
    .quick{margin:10px 0 0; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#f8fafc; text-align:center; display:flex; justify-content:center}
    .quick-row{display:inline-flex; gap:8px; align-items:center; justify-content:center; flex-wrap:nowrap}
    .quick input[type="tel"]{ width:clamp(220px, 50vw, 280px); max-width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--muted) }
    #quick-status{ min-height:22px; text-align:center; margin-top:8px }
    @media (max-width:480px){ .quick-row{ flex-wrap:wrap } .quick .btn{ width:auto } }

    /* 상품 안내 박스 */
    .prize-box{ margin:10px 0 0; padding:12px; border:1px dashed #d1d5db; border-radius:12px; background:#fafafa }
    .prize-box strong{ display:block; text-align:center; margin-bottom:6px }
    .prize-list{ list-style:none; padding:0; margin:0; text-align:center; color:#111827 }
    .prize-list li{ margin:4px 0 }

    /* 리더보드 준비중 모달 */
    .modal-overlay{ position:fixed; inset:0; background:rgba(17,24,39,.45); backdrop-filter:saturate(180%) blur(4px); display:none; align-items:center; justify-content:center; z-index:100 }
    .modal-overlay.open{ display:flex }
    .modal{ background:var(--paper); border:1px solid var(--muted); border-radius:16px; box-shadow:var(--shadow); width:min(420px, calc(100% - 40px)); padding:18px; text-align:center }
    .modal h3{ margin:6px 0 6px; font-size:18px }
    .modal p{ margin:0; color:#6b7280 }
    .modal-actions{ margin-top:12px; display:flex; gap:8px; justify-content:center }

    /* 비활성 문항 스타일 */
    fieldset.is-disabled{opacity:.72}
    fieldset.is-disabled .qgrid{pointer-events:none}
  </style>
</head>
<body>
  <header class="nav">
    <div class="nav-inner wrap">
      <a class="brand" href="index.html"><strong>🐛누에 고치 성별 맞추기 대회</strong></a>
      <div>
        <a class="btn" href="index.html">Home</a>
        <a class="btn primary" href="3rd_leaderboard.html">제 3회 리더보드</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <div class="hero-grid">
        <h1>제 3회 대회 참가 제출지</h1>
        <!-- … (상단 안내는 동일) … -->
      </div>
    </section>

    <!-- 참가자 정보 카드 … (동일) … -->

    <!-- 타입 규칙 카드 … (동일, 범례 카운트는 기존 유지: 일반(13)·황금(2)·미믹(3)·함정(2)) … -->

    <!-- 20개 문항 -->
    <form id="form" class="card" enctype="multipart/form-data" style="margin-top:18px" novalidate>
      <div class="inner">
        <h2 class="form-section-title" style="margin:0 0 8px">문항 (총 20문항)</h2>
        <div id="questions" style="display:grid;gap:12px;margin-top:8px"></div>

        <div class="actions">
          <button type="submit" class="btn success lg" id="btn-submit">제출</button>
          <button type="button" class="btn lg" id="btn-reset">초기화</button>
        </div>
        <div id="status" role="status" aria-live="polite"></div>

        <input class="hp" type="text" id="website" name="website" tabindex="-1" autocomplete="off" aria-hidden="true">
      </div>
    </form>
  </main>

  <!-- 리더보드 준비중 모달 … (동일) … -->

  <script>
    /* ====== 설정: 웹앱 URL ====== */
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxVl9s_cs47BxdB4QhE2HJgLZQKQ3lgAScF50FsYCHy-KEE21Uo92v7cEIXl3a-9fFugw/exec';

    /* 이미지 기본 경로 */
    const IMG_BASE = 'https://www.hanri.net/nunu/3rd_photo/';

    /* 타입 매핑: gold[5,16], trap[20,8], mimic[10,3,13], 나머지 normal */
    const GOLD  = new Set([5,16]);    // ✅ 11 제거, 16 추가
    const TRAP  = new Set([20,8]);
    const MIMIC = new Set([10,3,13]);

    /* 비활성 문항 */
    const DISABLED = new Set([17]);   // ✅ 17 비활성 유지(검증/전송 제외 처리)

    function getType(idx1){
      if(GOLD.has(idx1)) return 'gold';
      if(TRAP.has(idx1)) return 'trap';
      if(MIMIC.has(idx1)) return 'mimic';
      return 'normal';
    }
    function typeKorean(t){
      return t==='gold'?'황금고치':t==='trap'?'함정고치':t==='mimic'?'미믹고치':'일반고치';
    }
    function ruleText(t){
      switch(t){
        case 'gold': return '정답 +3 / 오답 0';
        case 'mimic': return '정답 +2 / 오답 −2';
        case 'trap': return '정답 −3 / 오답 0';
        default: return '정답 +1 / 오답 0';
      }
    }
    const pad2 = (n)=> String(n).padStart(2,'0');

    /* 이름 → 파일명 */
    function toFileName(idx, displayName){
      const num = pad2(idx);
      const raw = (displayName||'').replace(/^\s*\d+\s*[\.\-_\)]*\s*/,'');
      const withUnderscore = raw.trim().replace(/\s+/g,'_').replace(/^_+|_+$/g,'');
      const encoded = encodeURIComponent(withUnderscore);
      return `${num}_${encoded}.jpg`;
    }

    /* 문항 이름 */
    const ITEMS = [
      { name:'01. 누리다' },
      { name:'02. 누낭비강문합술' },
      { name:'03. 누가복음' },
      { name:'04. 누워있는 누에' },
      { name:'05. 누에엥' },
      { name:'06. 누산기' },
      { name:'07. 누가 내머리에 똥쌌어' },
      { name:'08. 누거덩거덩스' },
      { name:'09. 누에엣' },
      { name:'10. 누명에서 벗어난 누에' },
      { name:'11. 누구보다 빠르게' },   // ✅ 일반고치
      { name:'12. 누붕이' },
      { name:'13. 누항사' },
      { name:'14. 누우면안돼' },
      { name:'15. 누누와 윌럼프' },
      { name:'16. 누누 에스피리투 산투' }, // ✅ 황금고치
      { name:'17. 누차 말하지만 누에는 누에엥' }, // ✅ 비활성 + 황금 "표시"
      { name:'18. 누진다 초점렌즈' },
      { name:'19. 누좋' },
      { name:'20. 누구야' }
    ];

    const $ = (s)=>document.querySelector(s);
    const Q_TOTAL = ITEMS.length;

    /* 전화 포맷 */
    const onlyDigits = (s)=> (s||'').replace(/[^\d]/g,'');
    function format344(d){
      d = onlyDigits(d).slice(0,11);
      if (d.length <= 3) return d;
      if (d.length <= 7) return d.slice(0,3)+'-'+d.slice(3);
      return d.slice(0,3)+'-'+d.slice(3,7)+'-'+d.slice(7);
    }
    const phoneInput = document.getElementById('phone');
    phoneInput.addEventListener('input', ()=>{
      const v = format344(phoneInput.value);
      phoneInput.value = v;
      phoneInput.setSelectionRange(v.length, v.length);
    });
    phoneInput.addEventListener('blur', ()=>{ phoneInput.value = format344(phoneInput.value); });

    /* 문항 렌더링 */
    const qWrap = $('#questions');
    ITEMS.forEach((it, idx)=>{
      const i = idx + 1;
      const t = getType(i);                // 실제 타입(전송/채점 용)
      const disabled = DISABLED.has(i);    // 비활성 여부
      const fileName = toFileName(i, it.name);
      const imgUrl = IMG_BASE + fileName;

      // 배지 표시 타입: 17번은 비활성이어도 "표시만" 황금으로
      const badgeType = (i === 17) ? 'gold' : t;

      const fs = document.createElement('fieldset');
      fs.dataset.index = i;
      fs.className = `type-${t}` + (disabled ? ' is-disabled' : '');
      if(disabled){ fs.dataset.disabled = '1'; }

      const pillHTML = disabled
        ? `<div class="pill disabled" aria-label="비활성 문항">제출 비활성(확인 불가)</div>`
        : `<div class="pill ${t}" aria-label="점수 규칙">${ruleText(t)}</div>`;

      const requiredStar = disabled ? '' : `<span class="req" style="color:#ef4444">*</span>`;
      const helpHTML = disabled ? '' : `<div class="help-err" data-help style="display:none">이 문항의 성별을 선택하십시오.</div>`;

      fs.innerHTML = `
        <legend>문항 ${i}</legend>
        <div class="qgrid">
          <div class="photo" aria-disabled="${disabled?'true':'false'}">
            <img src="${imgUrl}" alt="${it.name} 사진" draggable="false" oncontextmenu="return false" onerror="this.alt='이미지를 불러올 수 없습니다.'">
            <span class="flag ${badgeType}" aria-label="${typeKorean(badgeType)} 배지">
              <i>${badgeType==='gold'?'✨':badgeType==='mimic'?'😏':badgeType==='trap'?'⚠️':'🐛'}</i>${typeKorean(badgeType)}
            </span>
          </div>
          <div>
            <div class="name">${it.name}</div>
            ${pillHTML}
            <div class="subnote">${disabled ? '이 문항의 고치는 성별을 확인할 수 없습니다.' : '이미지를 참고하여 성별을 선택하십시오.'}</div>
          </div>
          <div>
            <label>성별 선택 ${requiredStar}</label>
            <div class="radios" role="radiogroup" aria-label="${it.name} 성별 선택">
              <label class="radio" data-type="F">
                <input type="radio" name="q${i}_gender" value="F" ${disabled?'disabled':''}/>
                <span>암컷</span>
              </label>
              <label class="radio" data-type="M">
                <input type="radio" name="q${i}_gender" value="M" ${disabled?'disabled':''}/>
                <span>수컷</span>
              </label>
            </div>
            ${helpHTML}
          </div>
        </div>
      `;
      qWrap.appendChild(fs);
    });

    /* 이미지 우클릭/드래그 방지 */
    document.addEventListener('contextmenu', (e)=>{ if(e.target && e.target.tagName==='IMG') e.preventDefault(); });
    document.addEventListener('dragstart', (e)=>{ if(e.target && e.target.tagName==='IMG') e.preventDefault(); });

    // 선택 토글
    function paintGroup(group){
      const labels = group.querySelectorAll('.radio');
      labels.forEach(lb => lb.classList.remove('selected-f','selected-m'));
      const checked = group.querySelector('input[type="radio"]:checked');
      if(!checked) return;
      const type = checked.value;
      const activeLabel = checked.closest('.radio');
      if(type === 'F'){ activeLabel.classList.add('selected-f'); }
      if(type === 'M'){ activeLabel.classList.add('selected-m'); }
      const fs = group.closest('fieldset');
      fs.classList.remove('invalid');
      const help = fs.querySelector('[data-help]');
      if(help){ help.style.display = 'none'; }
    }
    qWrap.addEventListener('change', (e)=>{
      const t = e.target;
      if(t.matches('input[type="radio"][name$="_gender"]')){
        const group = t.closest('.radios');
        paintGroup(group);
      }
    });

    // 초기화
    $('#btn-reset').addEventListener('click', ()=>{
      document.getElementById('form').reset();
      document.querySelectorAll('.radio').forEach(lb=>lb.classList.remove('selected-f','selected-m'));
      document.querySelectorAll('fieldset').forEach(fs=>fs.classList.remove('invalid'));
      document.querySelectorAll('[data-help]').forEach(el=>el.style.display='none');
      ['nickname','realname','phone'].forEach(id=>$('#'+id).classList.remove('invalid'));
      $('#agreeWrap').classList.remove('checkbox-invalid');
      $('#status').textContent = '';
    });

    // 검증
    function validateAllWithAlert(){
      const issues = [];
      const nickname = $('#nickname');
      const realname = $('#realname');
      const phone = $('#phone');
      const agree = $('#agree');

      [nickname,realname,phone].forEach(i=>i.classList.remove('invalid'));
      $('#agreeWrap').classList.remove('checkbox-invalid');

      const phoneDigits = (phone.value||'').replace(/[^\d]/g,'');
      if(!nickname.value.trim()){
        issues.push('닉네임'); nickname.classList.add('invalid');
      }
      if(!realname.value.trim()){
        issues.push('이름'); realname.classList.add('invalid');
      }
      if(!phoneDigits){
        issues.push('휴대폰 번호'); phone.classList.add('invalid');
      }else if(phoneDigits.length !== 11){
        issues.push('휴대폰 번호(11자리)'); phone.classList.add('invalid');
      }else{
        phone.value = format344(phone.value);
      }
      if(!agree.checked){
        issues.push('개인정보 동의'); $('#agreeWrap').classList.add('checkbox-invalid');
      }

      const missingQuestions = [];
      for(let i=1;i<=Q_TOTAL;i++){
        if (DISABLED.has(i)) continue; // 비활성 문항은 검증 제외
        const fs = document.querySelector(`fieldset[data-index="${i}"]`);
        const checked = document.querySelector(`input[name="q${i}_gender"]:checked`);
        const help = fs.querySelector('[data-help]');
        if(!checked){
          missingQuestions.push(i);
          fs.classList.add('invalid');
          if(help) help.style.display = 'inline-block';
        }else{
          fs.classList.remove('invalid');
          if(help) help.style.display = 'none';
        }
      }

      if(issues.length || missingQuestions.length){
        let msg = '';
        if(issues.length) msg += `미입력 항목: ${issues.join(', ')}\n`;
        if(missingQuestions.length) msg += `미선택 문항: ${missingQuestions.join(', ')}`;
        alert(msg.trim());
        const firstMiss = missingQuestions[0];
        if(firstMiss){
          document.querySelector(`fieldset[data-index="${firstMiss}"]`).scrollIntoView({behavior:'smooth', block:'center'});
        }else if(issues.length){
          (nickname.classList.contains('invalid') ? nickname :
           realname.classList.contains('invalid') ? realname :
           phone).focus();
        }
        return { ok:false };
      }
      return { ok:true };
    }

    const showStatusError = (msg)=>{ $('#status').innerHTML = `<span class="notice notice-err">${msg}</span>`; };
    const showStatusOk   = (msg)=>{ $('#status').innerHTML = `<span class="notice notice-ok">${msg}</span>`; };

    // 중복 확인
    async function checkPhoneDuplicate(phoneInput){
      const raw = String(phoneInput || '');
      const digits = onlyDigits(raw).slice(0,11);
      const digitsNoLead0 = digits.replace(/^0+/, '');
      const hyphen = format344(digits);
      const hyphenNoLead0 = format344(digitsNoLead0);

      const editionEl = document.getElementById('edition');
      const edition = editionEl ? (editionEl.value || '').trim() : '';
      const t = Date.now().toString();

      const base = [
        { action:'checkPhone', phone: digits, t },
        { action:'checkPhone', phone: hyphen, t },
        { action:'checkPhone', phone_norm: digits, t },
        { action:'checkPhone', phone: digitsNoLead0, t },
        { action:'checkPhone', phone_norm: digitsNoLead0, t },
        { action:'checkPhone', phone: hyphenNoLead0, t },
      ];
      const candidates = edition ? [
        ...base,
        { action:'checkPhone', phone: digits, edition, t },
        { action:'checkPhone', phone: hyphen, edition, t },
        { action:'checkPhone', phone_norm: digits, edition, t },
        { action:'checkPhone', phone: digitsNoLead0, edition, t },
        { action:'checkPhone', phone_norm: digitsNoLead0, edition, t },
        { action:'checkPhone', phone: hyphenNoLead0, edition, t },
      ] : base;

      const existsByData = (data)=>{
        if (!data) return false;
        if (typeof data.exists !== 'undefined'){
          const v = String(data.exists).toLowerCase();
          if (v === 'true' || v === '1' || v === 'yes' || v === 'y') return true;
          if (v === 'false' || v === '0' || v === 'no' || v === 'n') return false;
        }
        if (typeof data.count !== 'undefined'){
          const n = Number(data.count); if (!Number.isNaN(n) && n > 0) return true;
        }
        if (data && data.error === 'duplicate_phone') return true;
        if (Array.isArray(data) && data.length > 0) return true;
        if (Array.isArray(data?.rows) && data.rows.length > 0) return true;
        return false;
      };

      for (const p of candidates){
        try{
          const qs = new URLSearchParams(p).toString();
          const res = await fetch(`${ENDPOINT}?${qs}`, { method:'GET', cache:'no-store' });
          if (!res.ok) continue;
          const data = await res.json().catch(()=>null);
          if (existsByData(data)) return true;
        }catch(_){ /* 다음 방식 시도 */ }
      }
      return false;
    }

    // 참여 확인(퀵 체크)
    const quickPhone = document.getElementById('quick-phone');
    if (quickPhone){
      quickPhone.addEventListener('input', ()=>{
        const v = format344(quickPhone.value);
        quickPhone.value = v;
        quickPhone.setSelectionRange(v.length, v.length);
      });
      quickPhone.addEventListener('blur', ()=>{ quickPhone.value = format344(quickPhone.value); });
    }
    const quickBtn = document.getElementById('btn-quick-check');
    if (quickBtn){
      quickBtn.addEventListener('click', async ()=>{
        const st = document.getElementById('quick-status');
        const digits = onlyDigits((quickPhone?.value||'')).slice(0,11);
        st.innerHTML = '';
        if(digits.length !== 11){
          st.innerHTML = '<span class="notice notice-err">휴대폰 번호 11자리를 입력하십시오.</span>';
          quickPhone?.focus();
          return;
        }
        const prev = quickBtn.textContent; quickBtn.disabled = true; quickBtn.textContent = '확인 중…';
        try{
          const exists = await checkPhoneDuplicate(digits);
          st.innerHTML = exists
            ? '<span class="notice notice-ok">이미 참여 기록이 있습니다. <a href="3rd_leaderboard.html">리더보드</a>에서 확인하십시오.</span>'
            : '<span class="notice">&nbsp;아직 제출 기록이 없습니다. 지금 참여해 주십시오!</span>';
        }catch(err){
          st.innerHTML = '<span class="notice notice-err">확인 중 오류가 발생했습니다.</span>';
        }finally{
          quickBtn.disabled = false; quickBtn.textContent = prev;
        }
      });
    }

    // 제출 데이터
    function buildFormData(){
      const fd = new FormData();
      fd.set('edition', ($('#edition')||{}).value?.trim?.() || '제 3회');
      fd.set('nickname', $('#nickname').value.trim());
      fd.set('name', $('#realname').value.trim());
      fd.set('phone', $('#phone').value.trim());
      fd.set('phone_norm', onlyDigits($('#phone').value.trim()));
      fd.set('submittedAt', new Date().toISOString());
      for(let i=1;i<=Q_TOTAL;i++){
        const disabled = DISABLED.has(i);
        const t = getType(i); // 실제 타입(17은 normal로 전송)
        const name = ITEMS[i-1].name;
        const fileName = toFileName(i, name);
        const imgUrl = IMG_BASE + fileName;
        const g = disabled ? '' : ((document.querySelector(`input[name="q${i}_gender"]:checked`)||{}).value || '');
        fd.set(`q${i}_name`, name);
        fd.set(`q${i}_imageUrl`, imgUrl);
        fd.set(`q${i}_gender`, g);
        fd.set(`q${i}_type`, t);
        fd.set(`q${i}_disabled`, disabled ? 'true' : 'false');
      }
      return fd;
    }

    // 제출
    document.getElementById('form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      $('#status').textContent = '';

      const { ok } = validateAllWithAlert();
      if(!ok) return;

      const phoneDigits = ($('#phone').value || '').replace(/[^\d]/g,'');
      const btn = $('#btn-submit');
      btn.disabled = true; btn.textContent = '중복 확인 중…';

      try{
        const exists = await checkPhoneDuplicate(phoneDigits);
        if(exists){
          alert('이미 동일한 휴대폰 번호로 제출된 기록이 있습니다. 중복 제출은 불가합니다.');
          showStatusError('중복 번호로 제출 차단');
          btn.disabled = false; btn.textContent = '제출';
          return;
        }
      }catch(err){
        alert('중복 확인에 실패했습니다. 잠시 후 다시 시도하십시오.');
        showStatusError('중복 확인 실패');
        btn.disabled = false; btn.textContent = '제출';
        return;
      }

      btn.disabled = true; btn.textContent = '전송 중…';
      try{
        const res = await fetch(ENDPOINT, { method:'POST', body: buildFormData() });
        const data = await res.json().catch(()=>({ok:res.ok}));
        if(res.ok && data && data.ok){
          showStatusOk('제출 완료되었습니다. 감사합니다!');
          alert('제출이 완료되었습니다. 감사합니다!');
          document.getElementById('form').reset();
          document.querySelectorAll('.radio').forEach(lb=>lb.classList.remove('selected-f','selected-m'));
          document.querySelectorAll('fieldset').forEach(fs=>fs.classList.remove('invalid'));
          document.querySelectorAll('[data-help]').forEach(el=>el.style.display='none');
          ['nickname','realname','phone'].forEach(id=>$('#'+id).classList.remove('invalid'));
          $('#agreeWrap').classList.remove('checkbox-invalid');
        }else if (data && data.error === 'duplicate_phone'){
          alert('이미 동일한 휴대폰 번호로 제출된 기록이 있습니다. 중복 제출은 불가합니다.');
          showStatusError('중복 번호로 제출 차단');
        }else{
          showStatusError('서버 응답 오류가 발생했습니다.');
          alert('서버 응답 오류가 발생했습니다.');
          console.error('Server response:', data);
        }
      }catch(err){
        console.error(err);
        showStatusError('네트워크 오류가 발생했습니다.');
        alert('네트워크 오류가 발생했습니다.');
      }finally{
        btn.disabled = false; btn.textContent = '제출';
      }
    });

    // 리더보드 모달 동작 … (동일)
    (function(){
      const link = document.querySelector('a[href="3rd_leaderboard.html"]');
      const modal = document.getElementById('lb-modal');
      const closeBtn = document.getElementById('lb-close');
      const open = ()=>{ if(modal){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); } };
      const close = ()=>{ if(modal){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); } };
      if(link){ link.addEventListener('click', (e)=>{ e.preventDefault(); open(); }); }
      if(closeBtn){ closeBtn.addEventListener('click', close); }
      modal?.addEventListener('click', (e)=>{ if(e.target === modal) close(); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && modal?.classList.contains('open')) close(); });
    })();
  </script>
</body>
</html>
