<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>제 3회 리더보드 – 누에 고치 성별 맞추기 대회</title>
  <style>
    :root{
      --bg:#ffffff; --paper:#ffffff; --ink:#111827; --sub:#6b7280; --muted:#e5e7eb;
      --radius:14px; --shadow:0 10px 30px rgba(17,24,39,.08);
      --box-w:980px;

      /* category colors */
      --gold:#f59e0b;     /* 황금 */
      --mimic:#8b5cf6;    /* 미믹 */
      --bomb:#b91c1c;     /* 폭탄 (빨강) */
      --normal:#9ca3af;   /* 일반 */

      /* neutral chip (정답/오답 비공개 상태) */
      --chip-bg:#f3f4f6;  /* 회색 배경 */
      --chip-bd:#e5e7eb;
      --chip-tx:#374151;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,Arial,sans-serif}
    .wrap{max-width:1120px;margin:0 auto;padding:20px 24px}

    /* NAV */
    header.nav{position:sticky;top:0;backdrop-filter:saturate(180%) blur(8px);
      background:rgba(247,246,243,.75);border-bottom:1px solid var(--muted);z-index:50}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:10px 18px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--ink)}
    .brand strong{font-weight:800;letter-spacing:.2px}
    .nav-actions{display:flex;gap:8px;align-items:center;justify-content:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:999px;border:1px solid var(--muted);
      background:var(--paper);color:var(--ink);text-decoration:none;font-weight:600}
    .btn.primary{background:#4b5563;color:#ffffff;border:0}
    .btn:hover{box-shadow:0 6px 18px rgba(15,23,42,.08)}

    /* HERO */
    .hero{margin:14px auto 10px;border:1px solid var(--muted);border-radius:var(--radius);
      background:var(--paper);box-shadow:var(--shadow);max-width:var(--box-w)}
    .hero-inner{padding:16px 18px}
    .hero h1{margin:0;font-size:clamp(20px,3vw,28px);letter-spacing:-.2px;line-height:1.18}
    .lead{color:var(--sub);margin:8px 0 6px}
    .guides{color:#4b5563;margin:6px 0 0;padding-left:18px;list-style:disc}
    .guides li{margin:4px 0}

    /* 카드 */
    .card{background:var(--paper);border:1px solid var(--muted);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:hidden;max-width:var(--box-w);margin-left:auto;margin-right:auto}
    .card .inner{padding:16px 18px}
    h2{margin:0 0 10px;font-size:20px}

    /* 범례 */
    .legend{display:flex;flex-wrap:wrap;gap:10px 16px;align-items:center;margin:8px 0 10px;color:#374151}
    .legend .item{display:inline-flex;align-items:center;gap:8px}
    .legend .label{
      font-size:14px;
      writing-mode: horizontal-tb;
      text-orientation: mixed;
      white-space: nowrap;   /* ⬅ 세로쓰기 방지 */
    }
    .legend .label[data-type="bomb"]{color:var(--bomb);font-weight:700} /* 폭탄 라벨 빨강 */
    .legend-note{font-size:13px;color:#6b7280;margin-top:4px}

    /* 표 */
    .table-wrap{border:1px solid var(--muted);border-radius:12px;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
    thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--muted);
      text-align:left;padding:10px 12px;font-size:14px;color:#334155;white-space:nowrap}
    tbody td{padding:9px 12px;border-bottom:1px solid #f1f5f9;vertical-align:middle;overflow:hidden}
    tbody tr:hover{background:#fafafa}
    .rank-col{width:100px}
    .nick-col{width:190px}
    .score-col{width:70px}
    .rank{font-weight:800;white-space:nowrap}
    .nick{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .score{font-weight:800;white-space:nowrap}

    /* 20칸 그리드 */
    .answers{display:grid;grid-template-columns:repeat(20, minmax(18px,1fr));gap:3px;align-items:center;width:100%}

    /* 칩: 전부 회색 + '?' 1글자 (표 내부) */
    .chip{
      position:relative;display:inline-flex;align-items:center;justify-content:center;
      height:18px;border-radius:5px;border:1px solid var(--chip-bd);background:var(--chip-bg);
      color:var(--chip-tx);font-weight:800;letter-spacing:.2px;padding:0;width:100%;
    }
    .chip .t{font-size:11.5px;line-height:1}

    /* 칩 모서리 카테고리 표기(표 내부 기본) */
    .chip::after{
      content:"";position:absolute;top:-2px;left:-2px;width:0;height:0;
      border-bottom:10px solid transparent;border-left:10px solid var(--normal);
    }
    .chip[data-cat="gold"]::after{  border-left-color:var(--gold)}
    .chip[data-cat="mimic"]::after{ border-left-color:var(--mimic)}
    .chip[data-cat="bomb"]::after{  border-left-color:var(--bomb)}
    .chip[data-cat="normal"]::after{border-left-color:var(--normal)}

    /* ✅ 범례 칩만 크게 (리더보드 제목 바로 아래) */
    .legend .chip{
      height:28px;
      min-width:28px;
      width:auto;         /* 내부칩의 width:100% 오버라이드 */
      padding:0 10px;     /* 좌우 여백 */
      border-radius:8px;
    }
    .legend .chip .t{
      font-size:14px;     /* 물음표 크게 */
      line-height:1;
    }
    .legend .chip::after{
      top:-3px; left:-3px;
      border-bottom:12px solid transparent;
      border-left:12px solid var(--normal);
    }
    .legend .chip[data-cat="gold"]::after{  border-left-color:var(--gold)}
    .legend .chip[data-cat="mimic"]::after{ border-left-color:var(--mimic)}
    .legend .chip[data-cat="bomb"]::after{  border-left-color:var(--bomb)}
    .legend .chip[data-cat="normal"]::after{border-left-color:var(--normal)}
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="nav">
    <div class="nav-inner wrap">
      <a class="brand" href="index.html" aria-label="누에 대회 홈">
        <strong>🐛누에 고치 성별 맞추기 대회</strong>
      </a>
      <nav class="nav-actions">
        <a class="btn" href="index.html">HOME</a>
        <a class="btn primary" href="#">제 3회</a>
      </nav>
    </div>
  </header>

  <!-- HERO -->
  <main class="wrap">
    <div class="hero">
      <div class="hero-inner">
        <h1>🐛제 3회 리더보드</h1>
        <p class="lead">
          현재 비공개 상태로 칩은 <b>?</b> 한 글자로 가립니다. (툴팁은 <b>누에 이름</b>과 <b>카테고리</b>만 표시)
        </p>
        <ul class="guides">
          <li>표기 규칙: <b>암, 수</b> (내부 변환은 <code>S↔M</code>, <code>A↔F</code>로 동작)</li>
          <li>정답키(아래 <code>ANSWER_KEY_FM</code>)가 입력되면 점수/순위를 자동 계산합니다.</li>
        </ul>
      </div>
    </div>
  </main>

  <div class="wrap">
    <section class="card">
      <div class="inner">
        <h2>리더보드</h2>

        <!-- 카테고리 범례 (리더보드 바로 아래) -->
        <div class="legend" aria-label="카테고리 범례">
          <span class="item"><span class="chip" data-cat="gold"><span class="t">?</span></span><span class="label">황금고치</span></span>
          <span class="item"><span class="chip" data-cat="mimic"><span class="t">?</span></span><span class="label">미믹고치</span></span>
          <span class="item"><span class="chip" data-cat="bomb"><span class="t">?</span></span><span class="label" data-type="bomb">폭탄고치</span></span>
          <span class="item"><span class="chip" data-cat="normal"><span class="t">?</span></span><span class="label">일반고치</span></span>
        </div>
        <div class="legend-note">※ 비공개 모드입니다. 정답 공개 시 칩 텍스트를 “암/수”로, 내부는 “F/M”로 유지해 표시할 수 있어요.</div>

        <div class="table-wrap" id="tableWrap"><div style="padding:14px;color:var(--sub)">TSV 로딩 중…</div></div>
      </div>
    </section>
  </div>

  <script>
    /* ========================
       0) 설정: 정답키(F/M)와 카테고리 매핑
    ======================== */

    // ✅ 여기 20문항의 정답을 'F' 또는 'M'으로 입력하면 점수가 자동 계산됩니다.
    // 예시) "FFMMF... (길이 20)"  — 아직 모르면 빈 문자열("")로 두세요.
    const ANSWER_KEY_FM = "";  // <- 여기에 공식 정답키를 넣어줘 (예: "FFMMFFFFMMMMFFFFMMMM")

    // 카테고리 매핑 (번호 1~20 → '황금'|'미믹'|'폭탄'|'일반')
    // 비워두면 전부 '일반'
    const CAT_MAP = {
      // 예시)
      // 4:'황금', 13:'황금',
      // 6:'미믹', 12:'미믹', 18:'미믹',
      // 3:'폭탄', 17:'폭탄'
    };

    /* ===== 공통 유틸 ===== */
    const catToData = (cat) => cat==='황금' ? 'gold' : cat==='미믹' ? 'mimic' : cat==='폭탄' ? 'bomb' : 'normal';
    function medalRank(n){ if(n===1) return '🥇 1등'; if(n===2) return '🥈 2등'; if(n===3) return '🥉 3등'; return n+'등'; }
    function denseRank(rows){
      const arr = rows.slice().sort((a,b)=> (b.score??-Infinity) - (a.score??-Infinity));
      const uniq=[]; arr.forEach(r=>{ if(typeof r.score==='number' && !uniq.includes(r.score)) uniq.push(r.score); });
      const m = new Map(uniq.map((sc,i)=>[sc,i+1]));
      arr.forEach(r=> r._rank = typeof r.score==='number' ? m.get(r.score) : null);
      return arr;
    }
    const toFM = (ch) => (ch==='A'?'F':ch==='S'?'M':ch==='F'?'F':ch==='M'?'M':'?'); // A/S/F/M 모두 수용

    /* ===== TSV 파서 & 점수 ===== */
    function parseTSV(tsv){
      const lines = tsv.split(/\r?\n/).filter(Boolean);
      if(lines.length<2) return {headers:[], rows:[]};

      const header = lines[0].split('\t');
      const idx = Object.fromEntries(header.map((k,i)=>[k,i]));

      // 문제 이름(툴팁용)
      const firstData = lines[1].split('\t');
      const qNames = [];
      for(let i=1;i<=20;i++){
        const key = `q${i}name`;
        qNames.push(firstData[idx[key]]?.trim() || `Q${i}`);
      }

      const keyArr = (ANSWER_KEY_FM||"").trim().split("");
      const hasKey = keyArr.length===20 && keyArr.every(c=>c==='F'||c==='M');

      const rows = lines.slice(1).map((line, lineNo)=>{
        const c = line.split('\t');
        const nickname = (c[idx['nickname']]||'').trim() || (c[idx['name']]||'').trim() || `참가자${lineNo}`;
        const timestamp = (c[idx['timestamp']]||'').trim();
        const ansFM = Array.from({length:20}, (_,i)=>{
          const gk = `q${i+1}gender`;
          const v = (c[idx[gk]]||'').trim();
          return toFM(v||'?'); // 내부 저장만 FM
        });

        let score = null;
        if(hasKey){
          score = 0;
          for(let i=0;i<20;i++){
            const a = ansFM[i];
            const k = keyArr[i];
            if(a==='F' || a==='M'){
              if(a===k) score += 1;
            }
          }
        }

        return { nickname, timestamp, ans: ansFM.join(''), score };
      });

      return { headers:qNames, rows, hasKey };
    }

    /* ===== 렌더 ===== */
    function renderFromTSV(tsv){
      const parsed = parseTSV(tsv);

      // 카테고리 배열 준비
      const CATEGORY = Array.from({length:20}, (_,i)=> CAT_MAP[i+1] || '일반');

      // 점수 유무에 따라 정렬/순위
      const data = parsed.hasKey ? denseRank(parsed.rows) : parsed.rows; // 점수 없으면 입력 순서 유지

      const tbl = document.createElement('table');

      // THEAD
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th class="rank-col">순위</th>
          <th class="nick-col">닉네임</th>
          <th class="score-col">점수</th>
          <th>제출지</th>
        </tr>`;
      tbl.appendChild(thead);

      // TBODY
      const tbody = document.createElement('tbody');

      data.forEach((row)=>{
        const tr = document.createElement('tr');

        const tdRank = document.createElement('td');
        tdRank.className='rank';
        tdRank.textContent = (typeof row._rank==='number') ? medalRank(row._rank) : '—';

        const tdNick = document.createElement('td');
        tdNick.className='nick';
        tdNick.textContent = row.nickname || '-';

        const tdScore= document.createElement('td');
        tdScore.className='score';
        tdScore.textContent = (typeof row.score==='number') ? `${row.score}점` : '—';

        const tdAns = document.createElement('td');
        const wrap = document.createElement('div');
        wrap.className='answers';

        for(let i=0;i<20;i++){
          const chip = document.createElement('span');
          chip.className='chip';                 // 항상 회색 (비공개)
          chip.setAttribute('data-cat', catToData(CATEGORY[i]));
          chip.title = `${String(i+1).padStart(2,'0')}. ${parsed.headers[i]} · ${CATEGORY[i]}`;
          const t = document.createElement('span');
          t.className='t';
          t.textContent='?';                     // 비공개 모드: 칩 텍스트는 항상 ?
          chip.appendChild(t);
          wrap.appendChild(chip);
        }

        tdAns.appendChild(wrap);
        tr.appendChild(tdRank);
        tr.appendChild(tdNick);
        tr.appendChild(tdScore);
        tr.appendChild(tdAns);
        tbody.appendChild(tr);
      });

      tbl.appendChild(tbody);

      const host = document.getElementById('tableWrap');
      host.innerHTML='';
      host.appendChild(tbl);
    }

    /* ========================
       TSV 로드 (동일 폴더의 파일)
       - nunu3_responses.tsv 를 같은 폴더에 두세요.
    ======================== */
    fetch('nunu3_responses.tsv', {cache:'no-store'})
      .then(r => {
        if(!r.ok) throw new Error('TSV 로드 실패');
        return r.text();
      })
      .then(text => renderFromTSV(text))
      .catch(err => {
        console.error(err);
        const host = document.getElementById('tableWrap');
        host.innerHTML = '<div style="padding:14px;color:#b91c1c">TSV를 불러오지 못했습니다. HTML과 같은 폴더에 <b>nunu3_responses.tsv</b>를 넣어주세요.</div>';
      });
  </script>
</body>
</html>
