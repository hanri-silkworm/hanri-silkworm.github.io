<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì œ 3íšŒ ë¦¬ë”ë³´ë“œ â€“ ëˆ„ì— ê³ ì¹˜ ì„±ë³„ ë§ì¶”ê¸° ëŒ€íšŒ</title>
  <style>
    :root{
      --bg:#ffffff; --paper:#ffffff; --ink:#111827; --sub:#6b7280; --muted:#e5e7eb;
      --radius:14px; --shadow:0 10px 30px rgba(17,24,39,.08);
      --box-w:980px;

      --gold:#f59e0b; --mimic:#8b5cf6; --bomb:#b91c1c; --normal:#9ca3af;

      --chip-bg:#f3f4f6; --chip-bd:#e5e7eb; --chip-tx:#374151;

      --ok:#2563eb; --bad:#dc2626;
      --ok-bg:#dbeafe; --ok-bd:#93c5fd;
      --bad-bg:#fee2e2; --bad-bd:#fca5a5;

      --accent:#111827; --highlight:#fef3c7;
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,Arial,sans-serif}
    .wrap{max-width:1120px;margin:0 auto;padding:20px 24px}

    /* NAV */
    header.nav{position:sticky;top:0;backdrop-filter:saturate(180%) blur(8px);
      background:rgba(247,246,243,.75);border-bottom:1px solid var(--muted);z-index:50}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:10px 18px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--ink)}
    .brand strong{font-weight:800;letter-spacing:.2px}
    .nav-actions{display:flex;gap:8px;align-items:center;justify-content:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:999px;border:1px solid var(--muted);
      background:var(--paper);color:var(--ink);text-decoration:none;font-weight:600}
    .btn.primary{background:#4b5563;color:#ffffff;border:0}
    .btn:hover{box-shadow:0 6px 18px rgba(15,23,42,.08)}

    /* HERO */
    .hero{margin:14px auto 10px;border:1px solid var(--muted);border-radius:var(--radius);
      background:var(--paper);box-shadow:var(--shadow);max-width:var(--box-w)}
    .hero-inner{padding:16px 18px}
    .hero h1{margin:0;font-size:clamp(20px,3vw,28px);line-height:1.18}

    .lead{color:var(--sub);margin:8px 0 6px}
    .guides{color:#374151;margin:10px 0 0;padding-left:18px;list-style:disc}
    .guides li{margin:6px 0}
    .tt{font-family:ui-monospace,Menlo,Consolas,monospace;background:#f3f4f6;padding:1px 6px;border-radius:6px}
    .em{font-weight:800;color:var(--accent)}
    .blue{color:var(--ok);font-weight:800}
    .red{color:var(--bad);font-weight:800}
    .note{background:var(--highlight);padding:0 6px;border-radius:6px}

    /* ì¹´ë“œ/í…Œì´ë¸” */
    .card{background:var(--paper);border:1px solid var(--muted);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:hidden;max-width:var(--box-w);margin:0 auto}
    .card .inner{padding:16px 18px}
    h2{margin:0 0 10px;font-size:20px}

    .legend{display:flex;flex-wrap:wrap;gap:10px 16px;align-items:center;margin:8px 0 10px;color:#374151}
    .legend .item{display:inline-flex;align-items:center;gap:8px}
    .legend .label{font-size:14px;white-space:nowrap;font-weight:800}
    .legend .label[data-type="gold"]{color:var(--gold)}
    .legend .label[data-type="mimic"]{color:var(--mimic)}
    .legend .label[data-type="bomb"]{color:var(--bomb)}
    .legend-note{ margin-top:6px; font-size:12px; color:var(--sub); }

    .table-wrap{border:1px solid var(--muted);border-radius:12px;background:#fff;overflow-x:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
    thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--muted);
      text-align:left;padding:10px 12px;font-size:14px;color:#334155;white-space:nowrap}
    tbody td{padding:9px 12px;border-bottom:1px solid #f1f5f9;vertical-align:middle;overflow:hidden}
    tbody tr:hover{background:#fafafa}
    .rowno-col{width:46px;color:#64748b}
    .rank-col{width:120px}
    .nick-col{width:190px}
    .score-col{width:70px}
    .rowno{font-weight:700;opacity:.8}
    .rank{font-weight:800;white-space:nowrap}
    .nick{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .score{font-weight:800;white-space:nowrap}

    /* HOST ë±ƒì§€(ìˆœìœ„ì¹¸) */
    .host-pill{display:inline-flex;align-items:center;padding:0 8px;height:18px;border-radius:999px;background:#e5e7eb;color:#374151;font-size:12px;font-weight:800}

    /* ì¹© */
    .answers{display:grid;grid-template-columns:repeat(20, minmax(18px,1fr));gap:3px;align-items:center;width:100%}
    .chip{
      position:relative;display:inline-flex;align-items:center;justify-content:center;
      height:18px;border-radius:5px;border:1px solid var(--chip-bd);background:var(--chip-bg);
      color:var(--chip-tx);font-weight:800;letter-spacing:.2px;padding:0;width:100%;
    }
    .chip .t{font-size:11.5px;line-height:1}
    .chip::after{content:"";position:absolute;top:-2px;left:-2px;width:0;height:0;border-bottom:10px solid transparent;border-left:10px solid var(--normal)}
    .chip[data-cat="gold"]::after{  border-left-color:var(--gold)}
    .chip[data-cat="mimic"]::after{ border-left-color:var(--mimic)}
    .chip[data-cat="bomb"]::after{  border-left-color:var(--bomb)}
    .chip[data-cat="normal"]::after{border-left-color:var(--normal)}

    /* í™©ê¸ˆ ì¹©ì€ ìƒì‹œ ë…¸ë€ ë°°ê²½/í…Œë‘ë¦¬ */
    .chip[data-cat="gold"]{
      background:#fff7ed;     /* orange-50 */
      border-color:#fdba74;   /* orange-300 */
    }

    /* ê³µê°œ ì‹œ ì •/ì˜¤ë‹µ ê°•ì¡° */
    .chip.open.correct{ background:var(--ok-bg); border-color:var(--ok-bd); box-shadow:0 0 0 2px rgba(37,99,235,.18) inset }
    .chip.open.wrong{   background:var(--bad-bg); border-color:var(--bad-bd); box-shadow:0 0 0 2px rgba(220,38,38,.18) inset }
    .chip.open.correct .t{ color:var(--ok); font-weight:900 }
    .chip.open.wrong   .t{ color:var(--bad); font-weight:900 }
    .chip.open.correct:hover{ box-shadow:0 0 0 2px rgba(37,99,235,.28) inset }
    .chip.open.wrong:hover{   box-shadow:0 0 0 2px rgba(220,38,38,.28) inset }

    /* ë¹„í™œì„± ì¹©(ì œì™¸) */
    .chip.disabled{ opacity:.5; background:#f8fafc; border-style:dashed }
    .chip.disabled .t{ color:#6b7280; font-weight:800 }

    /* ë²”ë¡€ ì¹© í¬ê²Œ */
    .legend .chip{height:28px;min-width:28px;width:auto;padding:0 10px;border-radius:8px}
    .legend .chip .t{font-size:14px;line-height:1}
    .legend .chip::after{top:-3px;left:-3px;border-bottom:12px solid transparent;border-left:12px solid var(--normal)}
    .legend .chip[data-cat="gold"]::after{  border-left-color:var(--gold)}
    .legend .chip[data-cat="mimic"]::after{ border-left-color:var(--mimic)}
    .legend .chip[data-cat="bomb"]::after{  border-left-color:var(--bomb)}
    .legend .chip[data-cat="normal"]::after{border-left-color:var(--normal)}

    /* í˜¸ë²„ì¹´ë“œ */
    .hovercard{
      position:fixed; z-index:1000; pointer-events:none; opacity:0; transform:translateY(6px);
      transition:opacity .12s ease, transform .12s ease;
      background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 12px 28px rgba(2,6,23,.18);
      overflow:hidden; min-width:220px; max-width:280px;
    }
    .hovercard.show{opacity:1; transform:translateY(0)}
    .hovercard .meta{padding:10px 12px; font-size:13px; color:#334155; display:flex; align-items:center; gap:8px}
    .hovercard .pill{display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px; font-weight:700; font-size:12px; color:#fff}
    .pill.gold{background:var(--gold)} .pill.mimic{background:var(--mimic)}
    .pill.bomb{background:var(--bomb)} .pill.normal{background:var(--normal)}
    .pill.disabled{background:#9ca3af}
    .hovercard .imgwrap{display:flex; justify-content:center; align-items:center; width:100%; background:#f3f4f6; border-top:1px solid #e5e7eb; padding:8px 0}
    .hovercard .imgwrap img{display:block; width:25%; height:auto; object-fit:contain}
    .hovercard .text{display:inline-block; max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* NAV: ëª¨ë°”ì¼ í•œ ì¤„ ìœ ì§€ */
    header.nav .nav-inner{ flex-wrap:nowrap }
    .brand{ min-width:0 }
    .brand strong{ font-size:clamp(14px, 3.6vw, 18px); white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .nav-actions{ flex-shrink:0; gap:8px }
    .btn{ white-space:nowrap }

    @media (max-width:560px){
      .nav-inner{ padding:8px 10px; gap:8px }
      .btn{ padding:6px 10px; font-size:13px }
    }

    /* ë°˜ì‘í˜•: ì¹© ê·¸ë¦¬ë“œ ì••ì¶• */
    @media (max-width:1024px){
      .wrap{ padding:16px }
      .answers{ grid-template-columns: repeat(10, minmax(18px,1fr)); gap:4px }
      thead th, tbody td{ padding:8px 10px }
      .rank-col{ width:100px } .nick-col{ width:170px } .score-col{ width:64px }
      .chip{ height:20px } .chip .t{ font-size:12px }
    }
    @media (max-width:560px){
      .rowno-col, td.rowno{ display:none }
      thead th:nth-child(5), tbody td:nth-child(5){ display:none } /* ì œì¶œì§€ ìˆ¨ê¹€(ëª¨ë°”ì¼) */
      .wrap{ padding:12px }
      .hero h1{ font-size:22px }
      .guides{ margin-top:8px }
      thead th, tbody td{ padding:8px }
      .rank-col{ width:82px } .nick-col{ width:auto } .score-col{ width:84px }
      td.rank{ white-space:nowrap } td.score{ text-align:right }
    }
    @media (max-width:380px){
      .btn{ padding:5px 8px; font-size:12.5px }
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="nav">
    <div class="nav-inner wrap">
      <a class="brand" href="#"><strong>ğŸ›ëˆ„ì— ê³ ì¹˜ ì„±ë³„ ë§ì¶”ê¸° ëŒ€íšŒ</strong></a>
      <nav class="nav-actions">
        <a class="btn" href="https://www.hanri.net/nunu/index.html">HOME</a>
        <a class="btn primary" href="https://www.hanri.net/nunu/3rd_submit.html">ì œ 3íšŒ ì°¸ì—¬í•˜ê¸°</a>
      </nav>
    </div>
  </header>

  <!-- HERO -->
  <main class="wrap">
    <div class="hero">
      <div class="hero-inner">
        <h1>ğŸ›ì œ 3íšŒ ë¦¬ë”ë³´ë“œ</h1>
        <p class="lead">
          ì§€ê¸ˆì€ <span class="em">ë¹„ê³µê°œ ëª¨ë“œ</span>ë¼ ì œì¶œëœ ë¬¸í•­ì€ ì „ë¶€ <span class="tt">?</span> í•œ ê¸€ìë¡œë§Œ í‘œì‹œê°€ ë©ë‹ˆë‹¤.
        </p>
        <ul class="guides">
          <li><span class="em">ì¼ë°˜ê³ ì¹˜</span>ê°€ ìš°í™”ë˜ëŠ” ìˆœê°„ ì°¸ì—¬ë¥¼ ë§ˆë¬´ë¦¬í•˜ê³  ëª¨ë“  ì œì¶œì§€ê°€ <span class="em">ì˜¤í”ˆ</span>ë©ë‹ˆë‹¤.</li>
          <li>ì œì¶œì§€ì—ëŠ” <span class="em">ì•”/ìˆ˜</span>ë¡œ í‘œê¸°ê°€ ë˜ë©°, <span class="blue">íŒŒë‘(ì •ë‹µ)</span> Â· <span class="red">ë¹¨ê°•(ì˜¤ë‹µ)</span>ìœ¼ë¡œ êµ¬ë¶„í•©ë‹ˆë‹¤.</li>
          <li>ì œì¶œì§€ì— <span class="em">ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´</span> ëˆ„ì—ì˜ ì´ë¦„ê³¼ ëˆ„ì— ë‚˜ë°©ì‚¬ì§„ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
          <li><span class="em">1Â·2Â·3ìœ„</span>ë§Œ ğŸ¥‡/ğŸ¥ˆ/ğŸ¥‰ ì´ëª¨ì§€, ê·¸ ì™¸ëŠ” <span class="note">në“±</span> ìœ¼ë¡œ í‘œì‹œ ë©ë‹ˆë‹¤.</li>
          <li>ë™ì ìëŠ” <span class="em">ë™ì¼ ìˆœìœ„</span>ì´ë©°, ë‹¤ìŒ ìˆœìœ„ëŠ” <span class="em">ì—°ì†</span>ìœ¼ë¡œ ì´ì–´ì§‘ë‹ˆë‹¤.</li>
          <li class="note"> ğŸ“± <b>ëª¨ë°”ì¼</b>ì—ì„œëŠ” <b>ìˆœìœ„Â·ì ìˆ˜ë§Œ</b> í™•ì¸í•  ìˆ˜ ìˆì–´ìš”. ğŸ’» <b>PC/íƒœë¸”ë¦¿</b>ì—ì„œëŠ” ê° ì œì¶œì§€ì˜ <b>ë‹µ(F/M)</b>ê³¼ ì¹©ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ <b>ëˆ„ì— ë‚˜ë°© ì‚¬ì§„</b>ë„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. </li>
        </ul>
      </div>
    </div>
  </main>

  <div class="wrap">
    <section class="card">
      <div class="inner">
        <h2>ë¦¬ë”ë³´ë“œ</h2>

        <!-- ë²”ë¡€ -->
        <div class="legend" aria-label="ì¹´í…Œê³ ë¦¬ ë²”ë¡€">
          <span class="item">
            <span class="chip" data-cat="gold"><span class="t">?</span></span>
            <span class="label" data-type="gold">í™©ê¸ˆê³ ì¹˜</span>
          </span>
          <span class="item">
            <span class="chip" data-cat="mimic"><span class="t">?</span></span>
            <span class="label" data-type="mimic">ë¯¸ë¯¹ê³ ì¹˜</span>
          </span>
          <span class="item">
            <span class="chip" data-cat="bomb"><span class="t">?</span></span>
            <span class="label" data-type="bomb">í•¨ì •ê³ ì¹˜</span>
          </span>
          <span class="item">
            <span class="chip" data-cat="normal"><span class="t">?</span></span>
            <span class="label" data-type="normal">ì¼ë°˜ê³ ì¹˜</span>
          </span>
        </div>
        <p class="legend-note">
          â€» 17ë²ˆ ê³ ì¹˜ëŠ” ì„±ë³„ í™•ì¸ì´ ë¶ˆê°€í•˜ì—¬ <b>ì œì™¸</b>ë˜ì—ˆê³ , ì¶”ì²¨ìœ¼ë¡œ <b>16ë²ˆ ê³ ì¹˜ê°€ í™©ê¸ˆ</b>ì…ë‹ˆë‹¤.
        </p>

        <div class="table-wrap" id="tableWrap"><div style="padding:14px;color:var(--sub)">ë°ì´í„° ë¡œë”© ì¤‘â€¦</div></div>
      </div>
    </section>
  </div>

  <!-- Hovercard -->
  <div id="hovercard" class="hovercard" role="dialog" aria-hidden="true">
    <div class="meta"><span class="pill">â€”</span><span class="text" title="â€”">â€”</span></div>
    <div class="imgwrap"><img alt=""></div>
  </div>

  <script>
    /* ====== ìƒìˆ˜/ê·œì¹™ ====== */
    const API_URL = 'https://script.google.com/macros/s/AKfycbxIR59WstV5BOCrCyN-jgTQkkLKhrWX3bhuz3Pru95JidMYdC2WCxwwCQ9F-ERxhb84tA/exec';

    /* íŠ¹ìˆ˜ê³ ì¹˜ ëª©ë¡(í‘œì‹œ ì •ì±…ì— ì‚¬ìš©) */
    const SPECIALS_1BASED = new Set([3,5,8,10,13,16,20]);

    /* íŠ¹ìˆ˜ê³ ì¹˜ ì ìˆ˜/ê³µê°œ í† ê¸€ â€” í•œ ì¤„ë¡œ ON/OFF */
    const ENABLE_SPECIALS_SCORING = true;  // â† true: íŠ¹ìˆ˜ê³ ì¹˜ ì ìˆ˜ ë°˜ì˜ + ì¹© ê³µê°œ(F/M/ìƒ‰ì¹ ), false: ì ìˆ˜ ë¯¸ë°˜ì˜ + í•­ìƒ '?'

    /* ê°€ì¤‘ì¹˜ */
    const WEIGHT = {
      'ì¼ë°˜': { correct: +1, wrong: 0 },
      'í™©ê¸ˆ': { correct: +3, wrong: 0 },
      'ë¯¸ë¯¹': { correct: +2, wrong: -2 },
      'í•¨ì •': { correct: -3, wrong: 0 }
    };
    const getWeight = (cat, ok) => (WEIGHT[cat] || WEIGHT['ì¼ë°˜'])[ok ? 'correct' : 'wrong'];

    /* ì œì™¸ ë¬¸í•­(í‘œì‹œ/ì ìˆ˜ ëª¨ë‘ ì œì™¸) */
    const DISABLED_1BASED = new Set([17]);

    /* HOST ë³„ì¹­ & íŒì • (ë“±ìˆ˜ ì œì™¸ + ìˆœìœ„ì¹¸ HOST ë±ƒì§€, # ì¹¼ëŸ¼ì€ â€”) */
    const HOST_ALIASES = ['ëˆ„ì—ì§‘ì‚¬ (í•œë¦¬)', 'ëˆ„ì—ì§‘ì‚¬', 'í˜¸ìŠ¤íŠ¸'];
    const normNick = s => String(s||'').replace(/\s+/g,' ').trim();
    const isHost   = s => HOST_ALIASES.some(a => normNick(s) === normNick(a));

    /* ë°˜ì‘í˜• ë‹¨ìˆœí™” */
    const IS_MOBILE_SIMPLE = window.matchMedia('(max-width: 560px)').matches;

    /* ë³´ì¡° */
    const catToData = (cat) => cat==='í™©ê¸ˆ'?'gold':cat==='ë¯¸ë¯¹'?'mimic':cat==='í•¨ì •'?'bomb':'normal';
    const isFM = v => v === 'F' || v === 'M';
    function medalRank(n){ if(n===1) return 'ğŸ¥‡ 1ë“±'; if(n===2) return 'ğŸ¥ˆ 2ë“±'; if(n===3) return 'ğŸ¥‰ 3ë“±'; return n+'ë“±'; }
    function toFM(ch){ const c=String(ch||'').trim().toUpperCase(); if(c==='A') return 'F'; if(c==='S') return 'M'; if(c==='F'||c==='M') return c; return '?'; }
    function formatDisplayName(qno, rawName){ const name=String(rawName||'').trim(); return (/^\d{1,2}\.\s*/.test(name))?name:`${qno}. ${name}`; }

    /* === Hovercard === */
    function attachHovercard(){
      const card = document.getElementById('hovercard');
      const img = card.querySelector('img');
      const pill = card.querySelector('.pill');
      const text = card.querySelector('.text');
      const imgwrap = card.querySelector('.imgwrap');

      function showCard(x, y, chip){
        const qi0 = Number(chip.dataset.qindex);
        const qno = String(qi0+1).padStart(2,'0');
        const rawName = chip.dataset.qname || '';
        const dispName = formatDisplayName(qno, rawName);
        const catStr = chip.dataset.qcat;
        const catKey = chip.dataset.cat;
        const isDisabled = chip.dataset.disabled === '1';
        const url = isDisabled ? '' : (chip.dataset.qimg || '');

        pill.textContent = isDisabled ? 'ì œì™¸' :
                           (catStr==='í™©ê¸ˆ'?'í™©ê¸ˆê³ ì¹˜':catStr==='ë¯¸ë¯¹'?'ë¯¸ë¯¹ê³ ì¹˜':catStr==='í•¨ì •'?'í•¨ì •ê³ ì¹˜':'ì¼ë°˜ê³ ì¹˜');
        pill.className = `pill ${isDisabled ? 'disabled' : catKey}`;
        text.textContent = dispName;
        text.title = dispName;

        if(url && !isDisabled){
          img.src = url; img.alt = dispName; imgwrap.style.display='flex';
        } else {
          img.removeAttribute('src'); img.alt=''; imgwrap.style.display='none';
        }

        const pad=14, vw=Math.max(document.documentElement.clientWidth, window.innerWidth||0), vh=Math.max(document.documentElement.clientHeight, window.innerHeight||0);
        card.style.left = (x + pad) + 'px'; card.style.top = (y + pad) + 'px';
        card.classList.add('show'); card.setAttribute('aria-hidden','false');

        requestAnimationFrame(()=>{
          const rect = card.getBoundingClientRect();
          let left = rect.left, top = rect.top;
          if(rect.right > vw - 8) left = x - rect.width - pad;
          if(rect.bottom > vh - 8) top = y - rect.height - pad;
          card.style.left = Math.max(8, left) + 'px';
          card.style.top  = Math.max(8, top)  + 'px';
        });
      }
      function hideCard(){ card.classList.remove('show'); card.setAttribute('aria-hidden','true'); }

      const tableWrap = document.getElementById('tableWrap');
      tableWrap.addEventListener('mousemove', (e)=>{
        const target = e.target.closest('.chip');
        if(target){ showCard(e.clientX, e.clientY, target); }
        else{ hideCard(); }
      });
      tableWrap.addEventListener('mouseleave', hideCard);
    }

    /* === ì±„ì /ìƒ‰ì¹ /ì ìˆ˜ ê³„ì‚° ===
       - íŠ¹ìˆ˜ê³ ì¹˜:
         * ENABLE_SPECIALS_SCORING=true â†’ ì ìˆ˜ ë°˜ì˜ + ì¹© ê³µê°œ + ìƒ‰ì¹ 
         * ENABLE_SPECIALS_SCORING=false â†’ ì ìˆ˜ ë¯¸ë°˜ì˜ + ì¹© í•­ìƒ '?'
       - 16ë²ˆì€ ë¬´ì¡°ê±´ 'í™©ê¸ˆ' ì¹´í…Œê³ ë¦¬ë¡œ ì²˜ë¦¬ */
    function computeRowMetrics(row, qCount, specials, disabled, keyArr, category) {
      const ansArr = Array.from({length:qCount}, (_,i)=> toFM(row.answers?.[i]));
      const outCorr = Array(qCount).fill(null);
      let score = 0;

      const getCat = (i) => {
        const q1 = i+1;
        if (q1 === 16) return 'í™©ê¸ˆ'; // 16ë²ˆ ê°•ì œ í™©ê¸ˆ
        return category?.[i] || (specials.has(q1) ? 'í™©ê¸ˆ' : 'ì¼ë°˜');
      };

      // corr ìš°ì„  ì‚¬ìš©
      if (Array.isArray(row.corr) && row.corr.length === qCount) {
        for (let i=0;i<qCount;i++){
          const q1=i+1;
          if (disabled.has(q1)) continue;

          const cat = getCat(i);
          const c = row.corr[i];

          const isSpecial = specials.has(q1);
          if (isSpecial) {
            if (ENABLE_SPECIALS_SCORING) {
              if (c===1) { score += getWeight(cat, true); outCorr[i]=1; }
              else if (c===0) { score += getWeight(cat, false); outCorr[i]=0; }
              else { outCorr[i]=null; }
            } else {
              // OFF: ì ìˆ˜/ìƒ‰ì¹  ë¯¸ë°˜ì˜
              outCorr[i]=null;
            }
          } else {
            // ì¼ë°˜
            if (c===1) { score += getWeight('ì¼ë°˜', true); outCorr[i]=1; }
            else if (c===0) { score += getWeight('ì¼ë°˜', false); outCorr[i]=0; }
            else { outCorr[i]=null; }
          }
        }
        return { ansArr, corr: outCorr, score };
      }

      // key ì‚¬ìš©
      if (Array.isArray(keyArr) && keyArr.length === qCount) {
        for (let i=0;i<qCount;i++){
          const q1=i+1;
          if (disabled.has(q1)) continue;

          const cat = getCat(i);
          const a = ansArr[i], k = keyArr[i];
          const isSpecial = specials.has(q1);

          if (isFM(a) && isFM(k)) {
            const ok = (a===k);
            if (isSpecial) {
              if (ENABLE_SPECIALS_SCORING) {
                score += getWeight(cat, ok);
                outCorr[i] = ok ? 1 : 0;
              } else {
                outCorr[i] = null; // OFF: ìƒ‰ì¹  ì•ˆí•¨
              }
            } else {
              score += getWeight('ì¼ë°˜', ok);
              outCorr[i] = ok ? 1 : 0;
            }
          } else {
            outCorr[i] = null;
          }
        }
        return { ansArr, corr: outCorr, score };
      }

      // fallback
      const scoreFallback = (typeof row.score==='number') ? row.score : 0;
      return { ansArr, corr: outCorr, score: scoreFallback };
    }

    /* === ìˆœìœ„ ê³„ì‚°(í˜¸ìŠ¤íŠ¸ ì œì™¸) === */
    function rankExcludingHosts(rows){
      const nonHost = rows.filter(r=> !isHost(r.nickname));
      const sorted = nonHost.slice().sort((a,b)=> (b._score_eff??-Infinity) - (a._score_eff??-Infinity));
      const uniq=[]; sorted.forEach(r=>{ const v=r._score_eff; if(typeof v==='number' && !uniq.includes(v)) uniq.push(v); });
      const m = new Map(uniq.map((sc,i)=>[sc,i+1]));
      const rankMap = new Map(sorted.map(r=> [r.nickname, m.get(r._score_eff)]));

      rows.forEach(r=>{
        r._rank = isHost(r.nickname) ? null : (rankMap.get(r.nickname) ?? null);
      });

      return rows.slice().sort((a,b)=> (b._score_eff??-Infinity) - (a._score_eff??-Infinity));
    }

    function renderBoard(payload){
      const { qnames=[], qimgs=[], category=[], key, rows:rawRows=[] } = payload;
      const qCount = qnames.length || (rawRows[0]?.answers?.length ?? 0);
      const keyArr = Array.isArray(key) ? key.map(toFM) : null;

      /* ì´ë¯¸ì§€: ë¹„ì–´ìˆìœ¼ë©´ 'ì§ì „ ì´ë¯¸ì§€ URL'ì„ ì‚¬ìš© (carry-forward) */
      const filledImgs = (() => {
        let last = '';
        return Array.from({length:qCount}, (_,i)=>{
          const s = String(qimgs?.[i] || '').trim();
          if (s) { last = s; return s; }
          return last; // ì´ì „ ê°’ ìœ ì§€(ì—†ìœ¼ë©´ ë¹ˆë¬¸ìì—´)
        });
      })();

      // ì°¸ê°€ìë³„ ë©”íŠ¸ë¦­ ê³„ì‚°
      const rows = rawRows.map(r=>{
        const { ansArr, corr, score } = computeRowMetrics(r, qCount, SPECIALS_1BASED, DISABLED_1BASED, keyArr, category);
        return { ...r, _ansArr: ansArr, _corr: corr, _score_eff: score };
      });

      // ìˆœìœ„ ê³„ì‚°(í˜¸ìŠ¤íŠ¸ ì œì™¸) í›„ ì ìˆ˜ìˆœ ì •ë ¬
      const data = rankExcludingHosts(rows);

      // í…Œì´ë¸” êµ¬ì„±
      const tbl = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th class="rowno-col">#</th>
          <th class="rank-col">ìˆœìœ„</th>
          <th class="nick-col">ë‹‰ë„¤ì„</th>
          <th class="score-col">ì ìˆ˜</th>
          <th>ì œì¶œì§€</th>
        </tr>`;
      tbl.appendChild(thead);

      const tbody = document.createElement('tbody');

      data.forEach((row)=>{
        const tr = document.createElement('tr');

        // # (ì‹¤ì œ ë“±ìˆ˜; HOSTëŠ” â€”)
        const tdNo = document.createElement('td'); tdNo.className='rowno';
        if (isHost(row.nickname)) tdNo.textContent = 'â€”';
        else tdNo.textContent = (typeof row._rank==='number') ? (row._rank + '.') : 'â€”';

        // ìˆœìœ„(í˜¸ìŠ¤íŠ¸ë©´ HOST ë±ƒì§€)
        const tdRank = document.createElement('td'); tdRank.className='rank';
        if (isHost(row.nickname)) {
          const hostBadge = document.createElement('span');
          hostBadge.className = 'host-pill';
          hostBadge.textContent = 'HOST';
          tdRank.appendChild(hostBadge);
        } else {
          tdRank.textContent = (typeof row._rank==='number')? medalRank(row._rank) : 'â€”';
        }

        // ë‹‰ë„¤ì„
        const tdNick = document.createElement('td'); tdNick.className='nick';
        tdNick.textContent = row.nickname || '-';

        // ì ìˆ˜
        const tdScore= document.createElement('td'); tdScore.className='score';
        const scoreToShow = (typeof row._score_eff==='number') ? row._score_eff : null;
        tdScore.textContent = (scoreToShow==null ? 'â€”' : `${scoreToShow}ì `);

        // ì œì¶œì§€ ì¹©
        const tdAns = document.createElement('td');
        if (!IS_MOBILE_SIMPLE) {
          const wrap = document.createElement('div'); wrap.className='answers';

          for(let i=0;i<qCount;i++){
            const q1 = i+1;
            const isDisabled = DISABLED_1BASED.has(q1);
            const isSpecial  = SPECIALS_1BASED.has(q1);

            const chip = document.createElement('span');
            chip.className = 'chip' + (isDisabled ? ' disabled' : '');
            chip.dataset.disabled = isDisabled ? '1' : '0';

            // ë¼ë²¨: 16ë²ˆì€ ë¬´ì¡°ê±´ 'í™©ê¸ˆ'
            let catStr = category?.[i] || (isSpecial ? 'í™©ê¸ˆ' : 'ì¼ë°˜');
            if (q1 === 16) catStr = 'í™©ê¸ˆ';

            const catKey = catToData(catStr);
            chip.dataset.cat   = catKey;
            chip.dataset.qindex= i;
            chip.dataset.qname = qnames[i] || `Q${i+1}`;
            chip.dataset.qimg  = filledImgs[i] || '';
            chip.dataset.qcat  = catStr;

            const t = document.createElement('span'); t.className='t';

            // ê¸°ë³¸ ë¼ë²¨
            let label = isDisabled ? 'â€”' : '?';

            if(!isDisabled){
              if (isSpecial) {
                if (ENABLE_SPECIALS_SCORING) {
                  // íŠ¹ìˆ˜ ON: F/M í‘œì‹œ + ìƒ‰ì¹ 
                  const ch = row._ansArr?.[i];
                  if (ch==='F' || ch==='M') label = ch;
                  const cflag = row._corr?.[i];
                  if (cflag!=null) chip.classList.add('open', cflag===1 ? 'correct' : 'wrong');
                } else {
                  // íŠ¹ìˆ˜ OFF: í•­ìƒ '?'
                  label = '?';
                }
              } else {
                // ì¼ë°˜: ë‹µ ê¸°ë¡ë˜ë©´ í‘œì‹œ, corr ìˆìœ¼ë©´ ìƒ‰ì¹ 
                const ch = row._ansArr?.[i];
                if (ch==='F' || ch==='M') label = ch;
                const cflag = row._corr?.[i];
                if (cflag!=null) chip.classList.add('open', cflag===1 ? 'correct' : 'wrong');
              }
            }

            t.textContent = label;
            chip.appendChild(t);
            wrap.appendChild(chip);
          }
          tdAns.appendChild(wrap);
        }

        tr.appendChild(tdNo);
        tr.appendChild(tdRank);
        tr.appendChild(tdNick);
        tr.appendChild(tdScore);
        tr.appendChild(tdAns);
        tbody.appendChild(tr);
      });

      tbl.appendChild(tbody);
      const host = document.getElementById('tableWrap');
      host.innerHTML=''; host.appendChild(tbl);
      attachHovercard();
    }

    /* ë°ì´í„° ë¡œë“œ */
    fetch(API_URL, { cache:'no-store' })
      .then(r => r.json())
      .then(json => {
        if(!json || json.ok === false){
          throw new Error(json?.error || 'ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜');
        }
        renderBoard(json);
      })
      .catch(err => {
        console.error(err);
        const host = document.getElementById('tableWrap');
        host.innerHTML =
          '<div style="padding:14px;color:#b91c1c">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì›¹ì•± URLê³¼ ì‘ë‹µ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.</div>';
      });

    /* ì–µì œìš© ë³´ì•ˆ(ì™„ì „ ì°¨ë‹¨ ë¶ˆê°€) */
    document.addEventListener('contextmenu', e=>e.preventDefault());
    document.addEventListener('dragstart', e=>e.preventDefault());
    document.addEventListener('keydown', (e)=>{
      const k = e.key.toUpperCase();
      if (e.keyCode===123 || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(k)) || (e.ctrlKey && ['U','S','P'].includes(k))){
        e.preventDefault(); e.stopPropagation();
      }
    }, true);
  </script>
</body>
</html>
